# 价格约束与涨跌幅计算说明

本文档说明系统中“日内价格约束（A股涨跌幅限制+量化到分+更自然的内边距）”与“涨跌幅 (%) 计算”的统一规则，便于排查与对齐前后端显示。

## 一、统一的涨跌幅 (%) 计算

- 公式：当日涨跌幅(%) = (C_t − C_{t−1}) / C_{t−1} × 100
- 基准：
  - 预测区首日：C_{t−1} 取历史最后一个交易日的收盘价
  - 之后各日：C_{t−1} 取上一预测日的收盘价
- 应用位置：
  - 图表（预测线 hover 文案）
  - 预测数据表格中的“涨跌幅 (%)”列
- 结论：图表与表格的涨跌幅计算逻辑已一致

## 二、A股价格约束（合规与更自然的边界）

为保证“可实现性”，系统对每日 OHLC 进行后处理：

1. 按前一日收盘价 prev_close 计算当日允许区间：
   - band_min = prev_close × (1 − limit)
   - band_max = prev_close × (1 + limit)
   - limit 自动识别：
     - ST / *ST：5%
     - 科创板(688)/创业板(300)：20%
     - 其余：10%
   - 也可用环境变量覆盖：DAILY_LIMIT_PCT（如 0.1、0.2、0.05）

2. 价格量化到“分”：
   - band_min_2 = ceil(band_min × 100) / 100
   - band_max_2 = floor(band_max × 100) / 100

3. 更自然的约束（避免频繁贴边）：
   - 引入内边距 natural_margin（默认 0.2%，可用 NATURAL_MARGIN_PCT 设置，如 0.001=0.1%）
   - 内边界：
     - inner_min = min(band_max_2, max(band_min_2 × (1 + margin), band_min_2 + 0.01))
     - inner_max = max(band_min_2, min(band_max_2 × (1 − margin), band_max_2 − 0.01))
   - 裁剪逻辑（适用于 close/open/high/low）：
     - 先裁剪到 [band_min, band_max]，四舍五入到 2 位小数
     - 若结果仍在极限边界处（等于 band_min_2 或 band_max_2），则回退到内边界（inner_min/inner_max）
   - 最后统一校正 OHLC 关系：
     - high ≥ max(open, close, low)
     - low ≤ min(open, close, low)

4. 小数处理：
   - 显示层统一采用两位小数格式（NumberColumn(format='%.2f')），保留尾随 0

## 三、调试模式（原始预测对比）

- 侧边栏“🔧 高级参数”可开启“调试模式：显示原始预测(诊断)”
- 开启后，API 返回的 predictions 中会包含原始未约束的 raw_open/raw_high/raw_low/raw_close 字段，便于对比“模型原始输出 vs 约束后结果”，辅助定位是否因越界被回退到内边界
- 默认 UI 不直接展示 raw_*，避免干扰；仅用于诊断

## 四、常见问答

1) 为什么看到某些日的涨跌幅接近但不等于±10%/±20%？
- 因为“量化到分”与“自然内边距”，即便越界，也会回到内边界（例如 9.8% 或 9.9%），而非正好贴在涨/跌停价

2) 为什么 9/5 的开盘价与 9/4 的收盘价差距较大？
- 次日的开盘、最高、最低、收盘都会被限制在 [前收×(1±limit)] 的区间内；若模型原始预测越界，系统会在量化到分后回退到内边界，出现明显跳空是可能的（但仍合规）。

3) 如何进一步减少“贴边”观感？
- 调低温度 T、减小 top_p 或增加 sample_count 使原始波动更稳
- 调整 NATURAL_MARGIN_PCT 为 0.003(0.3%) 或 0.001(0.1%) 做微调

## 五、相关环境变量

- DAILY_LIMIT_PCT：覆盖 A 股日涨跌幅限制（示例：0.1、0.2、0.05）
- NATURAL_MARGIN_PCT：自然内边距比例（默认 0.002 即 0.2%）

## 六、验证建议

- 核对“📊 查看预测数据”中的“涨跌幅(%)”与图表 hover 的“涨跌幅”是否一致
- 在调试模式下，对比 raw_* 与最终值，确认是否因越界而回退到内边界

如需在图表 hover 中追加更多诊断信息（例如“基准价/内边界/极限价”等），可以进一步告知，我可按需增加（默认不展示，避免干扰）。
