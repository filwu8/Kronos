## 高级参数使用说明（预测引擎）

本说明解释侧边栏“🔧 高级参数”的含义、适用场景与建议值，并给出在不同硬件下的推荐组合。

---

### 一、参数总览

- 性能模式（performance_mode）
  - 标准模式：兼顾性能与稳定，默认“历史数据长度”上限为 1,000。
  - 高性能模式 (RTX 5090)：提升上限至 5,000（仅 UI 限制），用于更长历史的可视化与轻微稳定性提升。
  - 注意：是否真正使用“大 lookback”还取决于后端的快速模式（FAST_CPU_MODE），详见下文。

- 历史数据长度（lookback）
  - 影响范围：用于生成图表的历史段、以及模型可用的“最近上下文”。
  - 模型有效上下文通常有限（本项目默认 max_context=512），超出部分更多用于图表展示。

- 采样温度（temperature / T）
  - 控制预测分布的“发散度”。
  - 范围 0.1–2.0，默认 1.0。数值越大，预测多样性越高但稳定性下降；越小则更保守/平滑。

- 核采样概率（top_p）
  - 控制从累计概率前 p 的候选集中抽样，默认 0.9。
  - 越接近 1，多样性越高，越接近 0 越保守。

- 采样次数（sample_count）
  - 用于蒙特卡洛多路径模拟。次数越多，不确定性估计更充分，但时延更高。
  - 在 CPU 快速模式下会自动降到 1 以保证速度；GPU/高性能 CPU 可调高。

- 预测天数（pred_len）
  - 生成未来工作日的预测长度（按交易日计算）。
  - 跨周末/节假日时，自然日跨度会短于 pred_len。

---

### 二、后端“快速模式”对高级参数的影响

- 环境变量 FAST_CPU_MODE=1（默认在 run.md 一键命令中启用）
  - 目的：保障 CPU 上的响应速度与交互流畅度
  - 影响：后端会将 lookback 上限收敛到 200（忽略前端更大的选择），并降低蒙特卡洛样本数

- 若要使用更大的 lookback（例如 1,000+），请将 FAST_CPU_MODE=0：
  - 方法：参考 docs/lookback_guide.md 中的“CPU 高性能版”一键启动命令
  - 建议：24 核 CPU 可设置 $env:CPU_THREADS=24，以提升吞吐

---

### 三、推荐参数组合（按目标与硬件）

1) 交互流畅（CPU/标准模式）
- FAST_CPU_MODE=1
- lookback: 200–400
- pred_len: 30–60
- temperature: 0.8–1.0
- top_p: 0.85–0.95
- sample_count: 1

2) 效果均衡（CPU 高性能或 GPU）
- FAST_CPU_MODE=0（CPU 高性能）/ GPU 默认
- lookback: 800–1,200（CPU 高性能），1,000–2,000（GPU）
- pred_len: 30–90
- temperature: 0.9–1.1（可微调）
- top_p: 0.9
- sample_count: 10–30（GPU 或愿意等待的 CPU 高性能）

3) 长历史展示（视觉回顾为主）
- lookback: 5,000–10,000（对预测质量帮助有限，主要用于更长历史线）
- 其余：同“效果均衡”或按需求调整

---

### 四、实用建议

- 调参流程（建议）：
  1. 先固定 lookback 在 800–1,200，pred_len 在 30–60，sample_count=1，确定合理温度与 top_p；
  2. 稳定后，再加大 sample_count（10–30）估计不确定性；
  3. 如需展示更长历史，再拉大 lookback（若仅为视觉，不必期待显著提升预测稳定性）。

- 温度与 top_p 的配合：
  - 升高温度时，可适度降低 top_p，避免过度发散；
  - 反之亦然。保持其中一个为“锚点”，只调另一个更容易收敛到合适区间。

- 线程与资源：
  - CPU 模式：将 $env:CPU_THREADS 设为物理/逻辑核的合理值（24 核可设 24）。
  - GPU 模式：留意显存峰值，必要时降低 sample_count 或 lookback。

---

### 五、与前端 UI 的对应关系

- app/streamlit_app.py 中的“🔧 高级参数”对应：
  - 性能模式：标准/高性能 (RTX 5090)
  - 历史数据长度：滑块（上限在高性能模式为 5,000，可按需提高）
  - 采样温度：0.1–2.0，默认 1.0
  - 核采样概率 top_p：0.1–1.0，默认 0.9
  - 采样次数：1–3（UI 默认），后端在高性能路径可放大至 10–30

- 后端默认参数（app/prediction_service.py）：
  - max_context: 512（模型有效上下文）
  - clip: 5.0（数据裁剪）
  - 默认 pred_len: 30（可被前端覆盖）

---

如需我：
- 将前端“高性能模式”的 lookback 滑块上限提高到 10,000；
- 在 run.md 追加“CPU 高性能版”与“GPU 版”的一键启动段落；
- 为不同市场/股票预设参数模板；

请告诉我，我可以直接修改并提交。
