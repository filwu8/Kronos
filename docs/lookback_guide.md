## 历史数据长度（lookback）设置与性能指南

本指南解释“历史数据长度（lookback）”如何影响预测质量与性能，并给出在 CPU 24 核环境下的推荐值与启动方式。

---

### 1. 快速结论（推荐设置）

按用途推荐：
- 速度优先（交互调试/频繁试参）：200–400
- 均衡（较稳的效果与可接受的时延）：800–1,200
- 追求模型利用极限（CPU 24 核，能等、希望更稳健）：1,500–2,000
- 超长历史仅用于“画长线”（视觉/回顾，不显著提升模型效果）：5,000–10,000

注意：模型的“有效上下文”通常在几百到一两千以内（本项目默认 max_context=512）。超过此范围，预测质量的边际提升很小，但加载/渲染/处理成本会显著上升。超长历史更多用于可视化而非提升预测。

---

### 2. 为什么不是“越大越好”？

- 模型有效上下文限制：即便提供 5,000+ 的历史序列，模型在推理时会裁剪到自身可用的最大上下文（例如 512）。
- 时延与稳定性：更大的 lookback 会带来更重的数据准备、绘图与传输成本，UI 交互卡顿风险增加。
- 数据质量与时间跨度：过长历史覆盖跨市场阶段，统计特性变化较大，未必提升短期预测质量。

---

### 3. 图表显示 vs 预测上下文

- 图表显示：历史越长，回顾越完整（可选更长）；
- 预测上下文：对模型有效的是“最近的一段数据”，超过模型 max_context 的部分基本不会再被“看到”。

因此：“更长历史线”更多作用在可视化层面；若目标是提升预测稳定性/质量，优先保证最近 800–2,000 的数据干净、连续且质量好。

---

### 4. 如何真正启用“大 lookback”（关键：关闭快速模式）

后端在 CPU 快速模式（FAST_CPU_MODE=1）下会自动将 lookback 限制为 200，以换取更低时延。如果你要使用大 lookback，请务必：

- 关闭快速模式（FAST_CPU_MODE=0）
- 显式设置 CPU 线程数（例如 24）

PowerShell 一键启动（CPU 高性能版，复制整段回车即可）：

```powershell
$env:DEVICE = 'cpu'
$env:FAST_CPU_MODE = '0'    # 关键：关闭快速模式，解除 lookback=200 限制
$env:CPU_THREADS = 24       # 你的 24 核

$py = ".\.venv\Scripts\python.exe"

# 启动后端 API
Start-Process -FilePath $py -ArgumentList @(
  '-m','uvicorn','app.api:app','--host','0.0.0.0','--port','8000'
) -WindowStyle Minimized

# 启动前端
Start-Process -FilePath $py -ArgumentList @(
  '-m','streamlit','run','app/streamlit_app.py',
  '--server.port=8501','--server.address=0.0.0.0'
) -WindowStyle Minimized

Start-Process 'http://localhost:8501'
```

如果你已在使用根目录 run.md，请将其中的 FAST_CPU_MODE 改为 0，或让我为你追加“高性能 CPU 版”段落。

---

### 5. 前端滑块上限与自定义

当前前端“高性能模式 (RTX 5090)”中滑块上限为 5,000（仅是 UI 限制，不是系统极限）。如需更大：
- 可将滑块上限调整为 10,000（或你指定的值）。
- 注意：超长历史主要影响图表与数据传输时延，对预测质量提升有限。

（如需我替你改动 UI 上限，请告知目标上限数值）

---

### 6. 相关注意事项

- 预测天数（pred_len）与交易日：系统以“工作日（交易日）”生成预测日期，若选择 60 天，图表会显示 60 个工作日；跨周末与节假日时，实际日期跨度会短于自然日 60 天。
- 数据源完整性：更长的 lookback 要求数据源连续且干净；若存在缺失/异常，会触发清洗与对齐流程，额外耗时。
- 资源监控：在大 lookback 下关注内存和 CPU 利用率，必要时降低并发或缩短 lookback。

---

### 7. FAQ

- Q: 我把侧栏的“历史数据长度”拉到很大，但预测效果没明显改善？
  - A: 这是预期的。模型有效上下文有限（默认为 512）。建议关注最近 800–2,000 的数据质量，适度调参（温度、top_p），并使用多次采样做不确定性评估。

- Q: 我希望既要长历史线，又要快，怎么办？
  - A: 前端图表可以保留长历史用于展示，同时后端预测上下文仍以模型 max_context 为准。也可按需维持 FAST_CPU_MODE=1，折中体验。

- Q: 我是 24 核 CPU，能直接用 10,000+ 吗？
  - A: 技术上可行（内存/时延允许），但预测质量改善有限，主要是展示更长历史。若你愿意等待，1,500–2,000 已是比较合理的上限。

---

如需我：
- 将“历史数据长度”滑块上限改成 10,000；
- 在 run.md 中追加“高性能 CPU 版”一键命令；
- 或针对不同硬件（GPU/CPU）给出更细的推荐；

请直接告诉我，我可以立即落实到代码与文档中。
